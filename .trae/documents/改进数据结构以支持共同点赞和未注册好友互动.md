# 改进数据结构计划

## 1. 数据库模型修改

### 1.1 添加点赞表
创建 `EventLike` 表来记录每个用户对每个事件的点赞情况，防止重复点赞并支持共同点赞体验。

```python
class EventLike(db.Model):
    """事件点赞模型"""
    id = db.Column(db.Integer, primary_key=True)
    event_id = db.Column(db.Integer, db.ForeignKey('shared_event.id', ondelete='CASCADE'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id', ondelete='CASCADE'), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.now)
    
    # 确保每个用户对每个事件只能点赞一次
    __table_args__ = (db.UniqueConstraint('event_id', 'user_id', name='_event_user_like_uc'),)
```

### 1.2 修改 GameLog 表
添加 VRChat ID 和注册状态字段，为未来的影子玩家系统做准备。

```python
# 在 GameLog 模型中添加以下字段
player_vrc_id = db.Column(db.String(100))  # VRChat唯一ID
player_is_registered = db.Column(db.Boolean, default=False)
```

### 1.3 修改 SharedEvent 表
移除旧的 `likes` 字段，改为通过查询点赞表计算点赞数。

```python
# 从 SharedEvent 模型中移除以下行
# likes = db.Column(db.Integer, default=0)  # 点赞数
```

## 2. 路由和功能更新

### 2.1 更新点赞功能
修改 `/api/event/<int:event_id>/like` 路由，使用新的点赞表来记录和计算点赞数。

### 2.2 添加点赞状态检查
添加 API 路由来检查用户是否已经点赞了某个事件。

### 2.3 添加取消点赞功能
添加 API 路由支持取消点赞功能。

### 2.4 更新事件查询
修改事件查询逻辑，包括：
- 计算每个事件的点赞数
- 检查当前用户是否点赞了该事件

### 2.5 更新模板
更新前端模板以显示正确的点赞数和点赞状态。

## 3. 测试和验证

### 3.1 运行数据库迁移
使用 `reset_database.py` 脚本重新创建数据库表。

### 3.2 生成测试数据
确保生成的测试数据包含点赞记录。

### 3.3 手动测试
- 测试点赞功能，确保不会重复点赞
- 测试取消点赞功能
- 测试不同用户对同一事件的点赞效果
- 测试未注册好友的互动记录

## 4. 预期效果

### 4.1 点赞功能
- 每个用户对每个事件只能点赞一次
- 事件的点赞数是所有用户点赞的总和
- 注册好友可以看到相同的点赞数

### 4.2 未注册好友互动
- 可以记录未注册好友的 VRChat ID
- 为未来实现影子玩家系统奠定基础
- 支持更准确的好友匹配

## 5. 实施顺序

1. 修改数据库模型
2. 更新路由和功能
3. 更新模板
4. 测试和验证

这个计划将确保系统能够支持真正的共同点赞功能，并为未注册好友提供更好的互动体验，同时保持向后兼容性。
# 实现高级功能计划

## 1. 事件评论功能
### 数据库模型
```python
class EventComment(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    event_id = db.Column(db.Integer, db.ForeignKey('shared_event.id', ondelete='CASCADE'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id', ondelete='CASCADE'), nullable=False)
    content = db.Column(db.Text, nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.now)
    parent_id = db.Column(db.Integer, db.ForeignKey('event_comment.id', ondelete='CASCADE'), nullable=True)  # 支持回复
    
    user = db.relationship('User', backref='comments')
    event = db.relationship('SharedEvent', backref='comments')
    replies = db.relationship('EventComment', backref=db.backref('parent', remote_side=[id]))
```

### 路由设计
- `GET /api/event/<int:event_id>/comments` - 获取事件评论
- `POST /api/event/<int:event_id>/comments` - 创建评论
- `DELETE /api/event/<int:event_id>/comments/<int:comment_id>` - 删除评论

### 前端实现
- 在事件详情页添加评论列表和评论表单
- 支持评论回复功能
- 实时更新评论数

## 2. 事件统计与分析
### 路由设计
- `GET /api/stats/events` - 获取事件统计数据
- `GET /api/stats/friends` - 获取好友互动统计
- `GET /api/stats/worlds` - 获取世界访问统计

### 前端实现
- 添加统计页面
- 展示事件数量趋势图
- 展示好友互动热力图
- 展示世界访问频率分布

## 3. 好友活动动态
### 数据库模型
```python
class ActivityFeed(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id', ondelete='CASCADE'), nullable=False)
    activity_type = db.Column(db.String(50), nullable=False)  # create_event, like, comment, etc.
    target_id = db.Column(db.Integer, nullable=True)  # 关联的对象ID
    target_type = db.Column(db.String(50), nullable=True)  # 关联的对象类型
    created_at = db.Column(db.DateTime, default=datetime.now)
    
    user = db.relationship('User', backref='activities')
```

### 路由设计
- `GET /api/feed/friends` - 获取好友动态
- `POST /api/feed` - 创建活动记录（内部使用）

### 前端实现
- 添加动态页面
- 展示好友的事件创建、点赞、评论等活动
- 支持动态过滤和排序

## 5. 事件模板
### 数据库模型
```python
class EventTemplate(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id', ondelete='CASCADE'), nullable=False)
    name = db.Column(db.String(100), nullable=False)
    world_name = db.Column(db.String(200), nullable=False)
    world_tags = db.Column(db.Text)
    duration = db.Column(db.Integer)  # 预设持续时间（秒）
    notes = db.Column(db.Text)
    custom_tags = db.relationship('TemplateTag', backref='template', cascade='all, delete-orphan')
    
    user = db.relationship('User', backref='templates')

class TemplateTag(db.Model):
    template_id = db.Column(db.Integer, db.ForeignKey('event_template.id'), primary_key=True)
    tag_name = db.Column(db.String(50), primary_key=True)
```

### 路由设计
- `GET /api/templates` - 获取用户模板
- `POST /api/templates` - 创建模板
- `PUT /api/templates/<int:template_id>` - 更新模板
- `DELETE /api/templates/<int:template_id>` - 删除模板
- `POST /api/templates/<int:template_id>/use` - 使用模板创建事件

### 前端实现
- 添加模板管理页面
- 在事件创建页面添加模板选择功能
- 支持模板的创建、编辑、删除

## 6. 隐私控制
### 数据库模型扩展
```python
class SharedEvent(db.Model):
    # 添加隐私设置字段
    privacy = db.Column(db.String(20), default='public')  # public, friends, private
    
    # 更新查询逻辑，只返回用户有权限查看的事件
```

### 路由设计
- 更新事件创建和编辑路由，支持隐私设置
- 更新事件查询路由，考虑隐私权限

### 前端实现
- 在事件创建和编辑页面添加隐私控制选项
- 根据隐私设置显示事件可见性标识

## 7. 事件导出功能
### 路由设计
- `GET /api/events/export` - 导出事件数据
- 支持参数：format (csv, json, ics), start_date, end_date, tag

### 前端实现
- 在时间线页面添加导出按钮
- 支持选择导出格式和筛选条件

## 8. 高级可视化
### 路由设计
- `GET /api/visualization/timeline` - 获取时间线数据
- `GET /api/visualization/network` - 获取网络图数据
- `GET /api/visualization/heatmap` - 获取热力图数据

### 前端实现
- 添加可视化页面
- 使用Chart.js或D3.js实现高级图表
- 支持时间线可视化、社交网络图、活动热力图

## 9. 事件提醒
### 数据库模型
```python
class EventReminder(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    event_id = db.Column(db.Integer, db.ForeignKey('shared_event.id', ondelete='CASCADE'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id', ondelete='CASCADE'), nullable=False)
    reminder_time = db.Column(db.DateTime, nullable=False)
    is_sent = db.Column(db.Boolean, default=False)
    
    event = db.relationship('SharedEvent', backref='reminders')
    user = db.relationship('User', backref='reminders')
```

### 路由设计
- `GET /api/event/<int:event_id>/reminders` - 获取事件提醒
- `POST /api/event/<int:event_id>/reminders` - 创建提醒
- `PUT /api/reminders/<int:reminder_id>` - 更新提醒
- `DELETE /api/reminders/<int:reminder_id>` - 删除提醒

### 前端实现
- 在事件详情页添加提醒设置功能
- 支持设置提醒时间和重复规则
- 显示即将到来的提醒

## 10. 事件分享
### 数据库模型
```python
class EventShare(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    event_id = db.Column(db.Integer, db.ForeignKey('shared_event.id', ondelete='CASCADE'), nullable=False)
    share_token = db.Column(db.String(100), unique=True, nullable=False)
    expires_at = db.Column(db.DateTime, nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.now)
    
    event = db.relationship('SharedEvent', backref='shares')
```

### 路由设计
- `POST /api/event/<int:event_id>/share` - 生成分享链接
- `GET /share/<string:share_token>` - 访问分享的事件

### 前端实现
- 在事件详情页添加分享按钮
- 支持生成分享链接
- 支持分享到社交媒体

## 实现顺序
1. 首先实现数据库模型扩展
2. 然后实现核心路由功能
3. 最后实现前端交互
4. 按功能模块逐步测试

## 技术栈
- 后端：Flask, SQLAlchemy
- 前端：Bootstrap, JavaScript, Chart.js/D3.js
- 数据库：SQLite

## 预期效果
- 增强系统的社交功能和用户体验
- 提供丰富的数据统计和可视化
- 支持个性化的事件管理
- 增强系统的安全性和隐私保护
- 提供便捷的数据导出和分享功能
{% extends 'base.html' %}

{% block content %}
    <article class="visualization-page" role="article" aria-label="é«˜çº§å¯è§†åŒ–">
        <header class="page-header mb-4" role="banner">
            <h1 class="mb-2">ğŸ“Š é«˜çº§å¯è§†åŒ–</h1>
            <nav aria-label="é¢åŒ…å±‘å¯¼èˆª" class="breadcrumb-nav">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">æ—¶é—´çº¿</a></li>
                    <li class="breadcrumb-item active" aria-current="page">é«˜çº§å¯è§†åŒ–</li>
                </ol>
            </nav>
        </header>

        <div class="row">
            <!-- å¯¼èˆªé€‰é¡¹å¡ -->
            <div class="col-lg-12 mb-4">
                <nav>
                    <div class="nav nav-tabs" id="visualization-tabs" role="tablist">
                        <button class="nav-link active" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline-content" type="button" role="tab" aria-controls="timeline-content" aria-selected="true">æ—¶é—´çº¿è§†å›¾</button>
                        <button class="nav-link" id="network-tab" data-bs-toggle="tab" data-bs-target="#network-content" type="button" role="tab" aria-controls="network-content" aria-selected="false">ç¤¾äº¤ç½‘ç»œå›¾</button>
                    </div>
                </nav>
                <div class="tab-content" id="visualization-tab-content">
                    <!-- æ—¶é—´çº¿è§†å›¾ -->
                    <div class="tab-pane fade show active" id="timeline-content" role="tabpanel" aria-labelledby="timeline-tab">
                        <div class="card shadow-sm mt-4">
                            <div class="card-body">
                                <h2 class="card-title h5 mb-4">â° äº‹ä»¶æ—¶é—´çº¿</h2>
                                <div id="timeline-container" class="timeline-visualization" style="height: 600px;">
                                    <div class="text-center my-5">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                        </div>
                                        <p class="mt-2">æ­£åœ¨åŠ è½½æ—¶é—´çº¿æ•°æ®...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç¤¾äº¤ç½‘ç»œå›¾è§†å›¾ -->
                    <div class="tab-pane fade" id="network-content" role="tabpanel" aria-labelledby="network-tab">
                        <div class="card shadow-sm mt-4">
                            <div class="card-body">
                                <h2 class="card-title h5 mb-4">ğŸŒ ç¤¾äº¤ç½‘ç»œå›¾</h2>
                                <div id="network-container" class="network-visualization" style="height: 600px;">
                                    <div class="text-center my-5">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                        </div>
                                        <p class="mt-2">æ­£åœ¨åŠ è½½ç¤¾äº¤ç½‘ç»œæ•°æ®...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </article>
{% endblock %}

{% block scripts %}
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ—¶é—´çº¿å¯è§†åŒ–
            async function initTimeline() {
                try {
                    const response = await fetch('/api/visualization/timeline');
                    if (response.ok) {
                        const data = await response.json();
                        renderTimeline(data.data);
                    }
                } catch (error) {
                    console.error('åŠ è½½æ—¶é—´çº¿æ•°æ®å¤±è´¥:', error);
                }
            }
            
            function renderTimeline(data) {
                const container = document.getElementById('timeline-container');
                
                // åˆ›å»ºå›¾è¡¨
                const ctx = document.createElement('canvas');
                container.innerHTML = '';
                container.appendChild(ctx);
                
                // å¤„ç†æ•°æ®
                const labels = data.map(item => {
                    const date = new Date(item.start);
                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                });
                
                const durations = data.map(item => item.duration / 3600); // è½¬æ¢ä¸ºå°æ—¶
                
                // åˆ›å»ºæ¡å½¢å›¾
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æŒç»­æ—¶é—´ï¼ˆå°æ—¶ï¼‰',
                            data: durations,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'æŒç»­æ—¶é—´ï¼ˆå°æ—¶ï¼‰'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¥æœŸ'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const item = data[context.dataIndex];
                                        return `æŒç»­æ—¶é—´: ${item.duration / 3600} å°æ—¶\nä¸ ${item.friend} åœ¨ ${item.world}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // ç¤¾äº¤ç½‘ç»œå›¾å¯è§†åŒ–
            async function initNetwork() {
                try {
                    const response = await fetch('/api/visualization/network');
                    if (response.ok) {
                        const data = await response.json();
                        renderNetwork(data.data);
                    }
                } catch (error) {
                    console.error('åŠ è½½ç½‘ç»œæ•°æ®å¤±è´¥:', error);
                }
            }
            
            function renderNetwork(data) {
                const container = document.getElementById('network-container');
                container.innerHTML = '';
                
                // è®¾ç½®å°ºå¯¸
                const width = container.clientWidth;
                const height = 600;
                
                // åˆ›å»ºSVG
                const svg = d3.select(container)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .style('border', '1px solid #eee');
                
                // åˆ›å»ºåŠ›å¯¼å‘å›¾
                const simulation = d3.forceSimulation(data.nodes)
                    .force('link', d3.forceLink(data.edges).id(d => d.id).distance(100))
                    .force('charge', d3.forceManyBody().strength(-300))
                    .force('center', d3.forceCenter(width / 2, height / 2))
                    .force('collision', d3.forceCollide().radius(30));
                
                // ç»˜åˆ¶è¾¹
                const link = svg.append('g')
                    .attr('class', 'links')
                    .selectAll('line')
                    .data(data.edges)
                    .enter().append('line')
                    .attr('stroke', '#999')
                    .attr('stroke-opacity', 0.6)
                    .attr('stroke-width', 2);
                
                // ç»˜åˆ¶èŠ‚ç‚¹
                const node = svg.append('g')
                    .attr('class', 'nodes')
                    .selectAll('circle')
                    .data(data.nodes)
                    .enter().append('circle')
                    .attr('r', 20)
                    .attr('fill', d => {
                        if (d.is_current) return '#ff6b6b';
                        if (d.type === 'friend') return '#4ecdc4';
                        if (d.type === 'world') return '#45b7d1';
                        return '#95a5a6';
                    })
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 2)
                    .call(d3.drag()
                        .on('start', dragstarted)
                        .on('drag', dragged)
                        .on('end', dragended));
                
                // æ·»åŠ èŠ‚ç‚¹æ ‡ç­¾
                const labels = svg.append('g')
                    .attr('class', 'labels')
                    .selectAll('text')
                    .data(data.nodes)
                    .enter().append('text')
                    .text(d => d.name)
                    .attr('font-size', 12)
                    .attr('text-anchor', 'middle')
                    .attr('dy', 40);
                
                // åŠ›å¯¼å‘å›¾æ›´æ–°å‡½æ•°
                simulation.on('tick', () => {
                    link
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);
                    
                    node
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y);
                    
                    labels
                        .attr('x', d => d.x)
                        .attr('y', d => d.y);
                });
                
                // æ‹–æ‹½äº‹ä»¶å¤„ç†
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }
                
                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }
                
                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
            }
            
            // åˆå§‹åŒ–å¯è§†åŒ–
            initTimeline();
            
            // é€‰é¡¹å¡åˆ‡æ¢äº‹ä»¶
            document.getElementById('visualization-tabs').addEventListener('shown.bs.tab', function(event) {
                if (event.target.id === 'network-tab') {
                    initNetwork();
                }
            });
        });
    </script>
{% endblock %}
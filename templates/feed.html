{% extends 'base.html' %}

{% block content %}
    <article class="feed-page" role="article" aria-label="å¥½å‹æ´»åŠ¨åŠ¨æ€">
        <header class="page-header mb-4" role="banner">
            <h1 class="mb-2">ğŸ“± å¥½å‹åŠ¨æ€</h1>
            <nav aria-label="é¢åŒ…å±‘å¯¼èˆª" class="breadcrumb-nav">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">æ—¶é—´çº¿</a></li>
                    <li class="breadcrumb-item active" aria-current="page">å¥½å‹åŠ¨æ€</li>
                </ol>
            </nav>
        </header>

        <div class="row">
            <div class="col-lg-8">
                <!-- åŠ¨æ€åˆ—è¡¨ -->
                <div id="feed-container" class="feed-list">
                    <div class="text-center my-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2">æ­£åœ¨åŠ è½½å¥½å‹åŠ¨æ€...</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <!-- ä¾§è¾¹æ ä¿¡æ¯ -->
                <aside class="card shadow-sm mb-4" role="complementary" aria-label="åŠ¨æ€ä¿¡æ¯">
                    <div class="card-body">
                        <h3 class="card-title h5 mb-3">â„¹ï¸ åŠ¨æ€è¯´æ˜</h3>
                        <ul class="list-unstyled small">
                            <li class="mb-2">â€¢ ğŸ“… <strong>åˆ›å»ºäº‹ä»¶</strong> - å¥½å‹åˆ›å»ºäº†æ–°äº‹ä»¶</li>
                            <li class="mb-2">â€¢ â¤ï¸ <strong>ç‚¹èµ</strong> - å¥½å‹ç‚¹èµäº†äº‹ä»¶</li>
                            <li class="mb-2">â€¢ ğŸ’¬ <strong>è¯„è®º</strong> - å¥½å‹è¯„è®ºäº†äº‹ä»¶</li>
                            <li class="mb-2">â€¢ ğŸ‘¥ <strong>æ·»åŠ å¥½å‹</strong> - å¥½å‹æ·»åŠ äº†æ–°å¥½å‹</li>
                        </ul>
                    </div>
                </aside>
                
                <aside class="card shadow-sm" role="complementary" aria-label="å¥½å‹åˆ—è¡¨">
                    <div class="card-body">
                        <h3 class="card-title h5 mb-3">ğŸ‘¥ æˆ‘çš„å¥½å‹</h3>
                        <ul class="list-unstyled">
                            {% for friend in current_user.friends.all() %}
                                <li class="mb-2">
                                    <a href="#" class="friend-link text-decoration-none">
                                        {{ friend.username }}
                                    </a>
                                </li>
                            {% else %}
                                <li class="text-muted">æš‚æ— å¥½å‹</li>
                            {% endfor %}
                        </ul>
                    </div>
                </aside>
            </div>
        </div>
    </article>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ ¼å¼åŒ–æ—¥æœŸ
            function formatDate(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return date.toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } else if (diffDays < 7) {
                    return `${diffDays}å¤©å‰`;
                } else {
                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                }
            }
            
            // æ¸²æŸ“å•æ¡åŠ¨æ€
            function renderFeedItem(item) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'feed-item card shadow-sm mb-4';
                
                // æ ¹æ®æ´»åŠ¨ç±»å‹æ¸²æŸ“ä¸åŒçš„å†…å®¹
                let activityContent = '';
                let activityIcon = '';
                
                switch (item.activity_type) {
                    case 'create_event':
                        activityIcon = 'ğŸ“…';
                        activityContent = `åˆ›å»ºäº†æ–°äº‹ä»¶ <a href="${url_for('event_detail', event_id=item.target_id)}">${item.target_info.title}</a>`;
                        break;
                    case 'like':
                        activityIcon = 'â¤ï¸';
                        activityContent = `ç‚¹èµäº†äº‹ä»¶ <a href="${url_for('event_detail', event_id=item.target_id)}">${item.target_info.title}</a>`;
                        break;
                    case 'comment':
                        activityIcon = 'ğŸ’¬';
                        activityContent = `è¯„è®ºäº†äº‹ä»¶ <a href="${url_for('event_detail', event_id=item.target_info.event_id)}">æŸ¥çœ‹è¯„è®º</a>: "${item.target_info.content}"`;
                        break;
                    default:
                        activityIcon = 'ğŸ“±';
                        activityContent = `${item.activity_type}`;
                }
                
                itemDiv.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex">
                            <div class="flex-shrink-0 me-3">
                                <div class="avatar rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    ${item.user.username.charAt(0).toUpperCase()}
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h4 class="card-title h6 mb-0">
                                            <a href="#" class="text-decoration-none">${item.user.username}</a>
                                        </h4>
                                        <p class="card-text text-muted small">
                                            <span class="activity-icon">${activityIcon}</span> ${activityContent}
                                        </p>
                                    </div>
                                    <time class="text-muted small" datetime="${item.created_at}">
                                        ${formatDate(item.created_at)}
                                    </time>
                                </div>
                                
                                <!-- å¦‚æœæœ‰ç›®æ ‡ä¿¡æ¯ï¼Œæ˜¾ç¤ºæ›´å¤šè¯¦æƒ… -->
                                ${item.target_info && item.target_type === 'event' ? `
                                    <div class="mt-2 p-2 bg-light rounded">
                                        <p class="mb-1"><strong>ä¸–ç•Œ:</strong> ${item.target_info.world_name}</p>
                                        <p class="mb-0"><strong>å¥½å‹:</strong> ${item.target_info.friend_name}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                return itemDiv;
            }
            
            // åŠ è½½å¥½å‹åŠ¨æ€
            async function loadFriendsFeed() {
                try {
                    const response = await fetch('/api/feed/friends');
                    if (response.ok) {
                        const data = await response.json();
                        const feedContainer = document.getElementById('feed-container');
                        
                        if (data.feed && data.feed.length > 0) {
                            feedContainer.innerHTML = '';
                            data.feed.forEach(item => {
                                const feedItem = renderFeedItem(item);
                                feedContainer.appendChild(feedItem);
                            });
                        } else {
                            feedContainer.innerHTML = `
                                <div class="text-center my-5">
                                    <h4 class="text-muted">æš‚æ— å¥½å‹åŠ¨æ€</h4>
                                    <p class="text-muted mt-2">å½“æ‚¨çš„å¥½å‹åˆ›å»ºäº‹ä»¶ã€ç‚¹èµæˆ–è¯„è®ºæ—¶ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºåŠ¨æ€</p>
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½å¥½å‹åŠ¨æ€å¤±è´¥:', error);
                    const feedContainer = document.getElementById('feed-container');
                    feedContainer.innerHTML = `
                        <div class="text-center my-5">
                            <h4 class="text-danger">åŠ è½½å¤±è´¥</h4>
                            <p class="text-muted mt-2">æ— æ³•åŠ è½½å¥½å‹åŠ¨æ€ï¼Œè¯·ç¨åé‡è¯•</p>
                        </div>
                    `;
                }
            }
            
            // åˆå§‹åŠ è½½å¥½å‹åŠ¨æ€
            loadFriendsFeed();
            
            // è®¾ç½®å®šæ—¶åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
            setInterval(loadFriendsFeed, 30000);
        });
    </script>
{% endblock %}
{% extends 'base.html' %}

{% block content %}
    <article class="event-detail" role="article" aria-label="äº‹ä»¶è¯¦æƒ…">
        <header class="page-header mb-4" role="banner">
            <h1 class="mb-2">äº‹ä»¶è¯¦æƒ…</h1>
            <nav aria-label="é¢åŒ…å±‘å¯¼èˆª" class="breadcrumb-nav">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">æ—¶é—´çº¿</a></li>
                    <li class="breadcrumb-item active" aria-current="page">
                        ä¸ {{ event.friend_name }} åœ¨ {{ event.world.world_name }}
                    </li>
                </ol>
            </nav>
        </header>

        <div class="row">
            <!-- ä¸»è¦äº‹ä»¶å†…å®¹ -->
            <div class="col-lg-8">
                <section class="card shadow-sm mb-4" role="region" aria-labelledby="basic-info-heading">
                    <div class="card-body">
                        <h2 id="basic-info-heading" class="card-title h4 mb-4">åŸºæœ¬ä¿¡æ¯</h2>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4 text-muted">å¥½å‹:</dt>
                                    <dd class="col-sm-8">{{ event.friend_name }}</dd>
                                    
                                    <dt class="col-sm-4 text-muted">ä¸–ç•Œ:</dt>
                                    <dd class="col-sm-8">{{ event.world.world_name }}</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4 text-muted">å¼€å§‹æ—¶é—´:</dt>
                                    <dd class="col-sm-8">
                                        <time datetime="{{ event.start_time.isoformat() }}">
                                            {{ event.start_time.strftime('%Y-%m-%d %H:%M') }}
                                        </time>
                                    </dd>
                                    
                                    <dt class="col-sm-4 text-muted">ç»“æŸæ—¶é—´:</dt>
                                    <dd class="col-sm-8">
                                        <time datetime="{{ event.end_time.isoformat() }}">
                                            {{ event.end_time.strftime('%Y-%m-%d %H:%M') }}
                                        </time>
                                    </dd>
                                    
                                    <dt class="col-sm-4 text-muted">æŒç»­æ—¶é—´:</dt>
                                    <dd class="col-sm-8">
                                        {{ (event.duration // 3600) }}å°æ—¶{{ (event.duration % 3600) // 60 }}åˆ†é’Ÿ
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ä¸–ç•Œæ ‡ç­¾ -->
                <section class="card shadow-sm mb-4" role="region" aria-labelledby="world-tags-heading">
                    <div class="card-body">
                        <h2 id="world-tags-heading" class="card-title h5 mb-3">ä¸–ç•Œæ ‡ç­¾</h2>
                        <div class="d-flex flex-wrap gap-2" role="list" aria-label="ä¸–ç•Œæ ‡ç­¾åˆ—è¡¨">
                            {% if event.world.tags %}
                                {% for tag in event.world.tags.split(',') %}
                                    <span class="badge bg-secondary tag" role="listitem"
                                          aria-label="ä¸–ç•Œæ ‡ç­¾ï¼š{{ tag.strip() }}">
                                        {{ tag.strip() }}
                                    </span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted" aria-live="polite">æš‚æ— ä¸–ç•Œæ ‡ç­¾</span>
                            {% endif %}
                        </div>
                    </div>
                </section>

                <!-- è‡ªå®šä¹‰æ ‡ç­¾ -->
                <section class="card shadow-sm mb-4" role="region" aria-labelledby="custom-tags-heading">
                    <div class="card-body">
                        <h2 id="custom-tags-heading" class="card-title h5 mb-3">è‡ªå®šä¹‰æ ‡ç­¾</h2>
                        
                        <div class="d-flex flex-wrap gap-2 mb-3" role="list" aria-label="è‡ªå®šä¹‰æ ‡ç­¾åˆ—è¡¨">
                            {% if event.custom_tags %}
                                {% for tag in event.custom_tags %}
                                    <span class="badge bg-primary tag" role="listitem"
                                          aria-label="è‡ªå®šä¹‰æ ‡ç­¾ï¼š{{ tag.tag_name }}">
                                        {{ tag.tag_name }}
                                    </span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted" aria-live="polite">æš‚æ— è‡ªå®šä¹‰æ ‡ç­¾</span>
                            {% endif %}
                        </div>
                        
                        <!-- æ·»åŠ æ ‡ç­¾è¡¨å• -->
                        <form method="POST" action="{{ url_for('add_tag', event_id=event.id) }}" 
                              class="d-flex gap-2" role="form" aria-label="æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾">
                            <div class="flex-grow-1">
                                <label for="tag-input" class="visually-hidden">æ–°æ ‡ç­¾åç§°</label>
                                <input type="text" id="tag-input" name="tag_name" 
                                       class="form-control" 
                                       placeholder="è¾“å…¥æ–°æ ‡ç­¾åç§°"
                                       aria-describedby="tag-help"
                                       maxlength="50"
                                       autocomplete="off">
                                <small id="tag-help" class="form-text text-muted">
                                    è¯·è¾“å…¥ä¸è¶…è¿‡50ä¸ªå­—ç¬¦çš„æ ‡ç­¾åç§°
                                </small>
                            </div>
                            <button type="submit" class="btn btn-primary" aria-label="æ·»åŠ æ ‡ç­¾">
                                æ·»åŠ 
                            </button>
                        </form>
                    </div>
                </section>

                <!-- å¤‡æ³¨ä¿¡æ¯ -->
                <section class="card shadow-sm mb-4" role="region" aria-labelledby="notes-heading">
                    <div class="card-body">
                        <h2 id="notes-heading" class="card-title h5 mb-3">å¤‡æ³¨</h2>
                        
                        <form method="POST" action="{{ url_for('update_notes', event_id=event.id) }}" 
                              role="form" aria-label="ç¼–è¾‘å¤‡æ³¨">
                            <div class="mb-3">
                                <label for="notes-textarea" class="form-label visually-hidden">äº‹ä»¶å¤‡æ³¨</label>
                                <textarea id="notes-textarea" name="notes" rows="4" 
                                          class="form-control" 
                                          placeholder="æ·»åŠ æˆ–ç¼–è¾‘å…³äºæ­¤äº‹ä»¶çš„å¤‡æ³¨"
                                          aria-describedby="notes-help"
                                          autocomplete="off">{{ event.notes or '' }}</textarea>
                                <small id="notes-help" class="form-text text-muted">
                                    æ‚¨å¯ä»¥åœ¨æ­¤è®°å½•å…³äºæ­¤äº‹ä»¶çš„ä»»ä½•é¢å¤–ä¿¡æ¯
                                </small>
                            </div>
                            <button type="submit" class="btn btn-primary" aria-label="ä¿å­˜å¤‡æ³¨">
                                ä¿å­˜å¤‡æ³¨
                            </button>
                        </form>
                        
                        {% if event.notes %}
                            <div class="mt-3" role="status" aria-live="polite">
                                <p class="text-muted">
                                    <strong>å½“å‰å¤‡æ³¨:</strong> {{ event.notes }}
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </section>

                <!-- ç‚¹èµåŠŸèƒ½ -->
                <section class="card shadow-sm mb-4" role="region" aria-labelledby="likes-heading">
                    <div class="card-body">
                        <h2 id="likes-heading" class="card-title h5 mb-3">{% if event.is_liked_by_current_user %}â¤ï¸{% else %}ğŸ‘{% endif %} ç‚¹èµ</h2>
                        <button class="like-btn btn btn-outline-danger btn-lg {% if event.is_liked_by_current_user %}btn-danger text-white{% endif %}" 
                                data-event-id="{{ event.id }}"
                                data-liked="{{ 'true' if event.is_liked_by_current_user else 'false' }}"
                                aria-label="{% if event.is_liked_by_current_user %}å–æ¶ˆç‚¹èµ{% else %}ä¸ºäº‹ä»¶ç‚¹èµ{% endif %}ï¼Œå½“å‰ç‚¹èµæ•°ï¼š{{ event.like_count }}"
                                aria-live="polite">
                            <span class="like-icon">{% if event.is_liked_by_current_user %}â¤ï¸{% else %}ğŸ‘{% endif %}</span> 
                            <span class="like-count">{{ event.like_count }}</span>
                        </button>
                        <p class="text-muted mt-2 small">
                            {% if event.is_liked_by_current_user %}æ‚¨å·²ç»ç‚¹èµäº†æ­¤äº‹ä»¶ï¼Œå†æ¬¡ç‚¹å‡»å¯å–æ¶ˆç‚¹èµ{% else %}ç‚¹å‡»æŒ‰é’®è¡¨è¾¾æ‚¨å¯¹æ­¤äº‹ä»¶çš„å–œçˆ±{% endif %}
                        </p>
                    </div>
                </section>

                <!-- äº‹ä»¶ç®¡ç†æŒ‰é’® -->
                <section class="event-actions mt-4" role="region" aria-labelledby="actions-heading">
                    <h2 id="actions-heading" class="visually-hidden">äº‹ä»¶ç®¡ç†æ“ä½œ</h2>
                    <div class="d-flex gap-2" role="toolbar" aria-label="äº‹ä»¶æ“ä½œå·¥å…·æ ">
                        <a href="{{ url_for('edit_event', event_id=event.id) }}" 
                           class="btn btn-primary" role="button"
                           aria-label="ç¼–è¾‘æ­¤äº‹ä»¶">
                            ç¼–è¾‘äº‹ä»¶
                        </a>
                        <form method="POST" action="{{ url_for('delete_event', event_id=event.id) }}" 
                              onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº‹ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚');">
                            <button type="submit" class="btn btn-danger" role="button"
                                    aria-label="åˆ é™¤æ­¤äº‹ä»¶ï¼ˆæ­¤æ“ä½œä¸å¯æ¢å¤ï¼‰">
                                åˆ é™¤äº‹ä»¶
                            </button>
                        </form>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary ms-auto" role="button"
                           aria-label="è¿”å›æ—¶é—´çº¿åˆ—è¡¨">
                            è¿”å›æ—¶é—´çº¿
                        </a>
                    </div>
                </section>
            </div>
            
            <!-- ä¾§è¾¹æ ä¿¡æ¯ -->
            <aside class="col-lg-4" role="complementary" aria-label="äº‹ä»¶ç›¸å…³ä¿¡æ¯">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h3 class="card-title h5 mb-3">äº‹ä»¶ä¿¡æ¯</h3>
                        <dl class="row">
                            <dt class="col-sm-5 text-muted">äº‹ä»¶ID:</dt>
                            <dd class="col-sm-7">
                                <code>{{ event.id }}</code>
                            </dd>
                            
                            <dt class="col-sm-5 text-muted">è®°å½•æ—¥æœŸ:</dt>
                            <dd class="col-sm-7">
                                <time datetime="{{ event.start_time.isoformat() }}">
                                    {{ event.start_time.strftime('%Y-%m-%d') }}
                                </time>
                            </dd>
                            
                            <dt class="col-sm-5 text-muted">åˆ›å»ºè€…:</dt>
                            <dd class="col-sm-7">{{ event.user.username }}</dd>
                            
                            <dt class="col-sm-5 text-muted">æœ€åæ›´æ–°:</dt>
                            <dd class="col-sm-7">
                                <time datetime="{{ event.start_time.isoformat() }}">
                                    {{ event.start_time.strftime('%Y-%m-%d %H:%M') }}
                                </time>
                            </dd>
                        </dl>
                    </div>
                </div>
                
                <!-- å¿«é€Ÿæ“ä½œæç¤º -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title h5 mb-3">ğŸ’¡ å¿«é€Ÿæ“ä½œæç¤º</h3>
                        <ul class="list-unstyled small">
                            <li class="mb-2">â€¢ ä½¿ç”¨æ ‡ç­¾å¯ä»¥å¸®åŠ©æ‚¨æ›´å¥½åœ°åˆ†ç±»å’Œç»„ç»‡äº‹ä»¶</li>
                            <li class="mb-2">â€¢ æ·»åŠ è¯¦ç»†çš„å¤‡æ³¨æœ‰åŠ©äºå›é¡¾è®°å¿†</li>
                            <li class="mb-2">â€¢ ç‚¹èµåŠŸèƒ½å¯ä»¥è¡¨è¾¾æ‚¨å¯¹äº‹ä»¶çš„å–œçˆ±</li>
                            <li>â€¢ å®šæœŸæ•´ç†äº‹ä»¶å¯ä»¥ä¿æŒæ—¶é—´çº¿æ•´æ´</li>
                        </ul>
                    </div>
                </div>
            </aside>
        </div>
    </article>
{% endblock %}

{% block scripts %}
    <!-- ç‚¹èµåŠŸèƒ½è„šæœ¬ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ç‚¹èµæŒ‰é’®äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const eventId = this.dataset.eventId;
                    const likeCountSpan = this.querySelector('.like-count');
                    const likeIcon = this.querySelector('.like-icon');
                    const isLiked = this.dataset.liked === 'true';
                    
                    try {
                        // ç¡®å®šè¯·æ±‚æ–¹æ³•å’ŒURL
                        const method = isLiked ? 'DELETE' : 'POST';
                        const response = await fetch(`/api/event/${eventId}/like`, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            // æ›´æ–°ç‚¹èµæ•°
                            likeCountSpan.textContent = data.likes;
                            
                            // æ›´æ–°æŒ‰é’®çŠ¶æ€
                            if (isLiked) {
                                // å–æ¶ˆç‚¹èµ
                                this.classList.remove('btn-danger', 'text-white');
                                this.classList.add('btn-outline-danger');
                                likeIcon.textContent = 'ğŸ‘';
                                this.dataset.liked = 'false';
                                this.setAttribute('aria-label', `ä¸ºäº‹ä»¶ç‚¹èµï¼Œå½“å‰ç‚¹èµæ•°ï¼š${data.likes}`);
                                // æ›´æ–°æ ‡é¢˜
                                document.querySelector('#likes-heading').textContent = 'ğŸ‘ ç‚¹èµ';
                            } else {
                                // ç‚¹èµ
                                this.classList.remove('btn-outline-danger');
                                this.classList.add('btn-danger', 'text-white');
                                likeIcon.textContent = 'â¤ï¸';
                                this.dataset.liked = 'true';
                                this.setAttribute('aria-label', `å–æ¶ˆç‚¹èµï¼Œå½“å‰ç‚¹èµæ•°ï¼š${data.likes}`);
                                // æ›´æ–°æ ‡é¢˜
                                document.querySelector('#likes-heading').textContent = 'â¤ï¸ ç‚¹èµ';
                            }
                        }
                    } catch (error) {
                        console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
                    }
                });
            });
        });
    </script>
{% endblock %}